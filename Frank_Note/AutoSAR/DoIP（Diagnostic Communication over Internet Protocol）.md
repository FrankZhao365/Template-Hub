#ISO13400 #ISO14229

# 诊断激活线
为了降低能耗和减少电磁干扰。非诊断通信期间，将与诊断相关的功能处于关闭状态，这样一方面可以降低能耗，另一方面减少对网络带宽的消耗，从而降低电磁干扰。

# DoIP gatway
车内DoIP网关节点的作用，是实现以太网到其他网络总线（如CAN、LIN）的报文路由，这样便实现了DoIP诊断与传统网络总线的兼容。多种网络总线汇聚到DoIP网关，这大大的降低了布线的复杂性，并且提高了各总线网络中ECU的诊断效率

# DoIP edge node
它是直接与外部诊断仪进行物理连接的节点。边缘节点可作为一个网络交换机，将车内网与车外网组成同一子网；也可以作为一个网关，将车内网与车外网进行安全隔离，屏蔽非法的网络访问和网络攻击。实际上它同样是个网关，其次他用于连接外部测试设备，在外部设备和车内子网之间路由转发消息；相较于 DoIP 网关多了以太网激活线的硬线。

# IP地址分配

#DHCP #AutoIP #Static

   
## DHCP
 ![[Pasted image 20260113204039.png]]
[1] **DHCP Discover**：客户端广播寻找DHCP服务器
[2] **DHCP Offer**：DHCP服务器提供可用IP地址
[3] **DHCP Request**：客户端请求使用特定IP
[4] **DHCP ACK**：服务器确认分配
[5] **ARP检测**：客户端检测IP是否冲突
[6] **DHCP Decline**（可选）：如果冲突，拒绝分配并重新开始

## AutoIP
![[Pasted image 20260113210145.png]]
[1] **选择候选地址**：设备从链路本地地址范围（169.254.1.0到169.254.254.255）中随机选择一个候选IP地址。
[2] **ARP探测**：设备发送ARP请求（Probe）报文，查询候选IP地址是否已被其他设备使用。
	-[2.1]发送3次ARP请求，每次间隔1秒
	-[2.2]源IP地址为0.0.0.0，目标IP地址为候选IP
	-[2.3]如果收到ARP响应，说明地址已被占用
[3] **地址冲突检测**：
	**无响应**：如果3次ARP探测都未收到响应，说明地址可用
	**有响应**：收到ARP响应，说明地址冲突，重新选择候选地址并重复探测
[4] **地址声明**：确认地址可用后，设备发送ARP宣告（Announcement）报文。
	-[4.1]发送2次ARP宣告，每次间隔2秒
	-[4.2]源IP地址为候选IP，目标IP地址为广播地址
	-[4.3]告知网络中其他设备该地址已被占用
[5] **正式使用**：完成宣告后，设备正式使用该IP地址进行通信。

- 一般要求DoIP节点需要同时支持AutoIP和DHCP两种IP配置方式
- 标准中完成了两个相互矛盾的需求，1-IP地址配置取决于AutoIP和DHCP哪个先配置；2-DHCP的地址优先级高，可以取代之前配置的AutoIP地址，所以看下面定义的AutoIP的配置地址过程中要判断DHCP地址是否有效，如果无法通过DHCP配置IP地址进而使用AutoIP的IP地址，但在整个过程中还是持续检查DHCP地址的配置情况，至于需要等待多长时间应该是由OEM来决定的
- 标准同时定义了两种不同的IP配置方式一定有结合实际应用的考虑，设想如果所有的诊断场景都是诊断仪和设备1:1直连，那么只采用AutoIP一种机制完全匹配，但是对于1:N的场景，诊断的车辆数量可能会很多，通过AutoIP效率将会减少，IP配置就可能消耗大量时间，所以需要DHCP
![[Pasted image 20260113203441.png]]

# Vehicle Announcement
![[Pasted image 20260113210942.png]]
完成IP配置后车辆的DoIP实体会在A_DoIP_Announce_Wait 定时广播发送车辆声明消息车辆公告消息，其中包含了DoIP实体的诊断逻辑地址（可以类比DoCAN的物理请求/响应地址），对应车辆的VIN码（若已配置），实体标识符EID（唯一一个DoIP节点，一般为MAC地址）以及组标识符GID（用于在VIN尚未配置时定位一组DoIP节点）。这样的声明消息会连续波三次，如此升温就可以让外部诊断设备获取到将要进行通信的对象的基本信息，接下来根据收到的信息做筛选，与自己想要通信的车辆或者DoIP节点进行通信。